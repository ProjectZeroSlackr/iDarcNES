/*
 * snd_unix.c
 *
 * UNIX(tm) sound interface (mainly OSS)
 */

/* $Id: snd_unix.c,v 1.4 2000/06/25 17:04:32 nyef Exp $ */

#include <stdio.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <sys/ioctl.h>
#include <unistd.h>
#include "cop.h"
#include "ui.h"
#include "snd.h"
#include "unixdep.h"

#include <sys/soundcard.h>
#define SOUND_DEVICE "/dev/dsp"
#ifdef SYSTEM_LINUX
#endif

#ifdef SYSTEM_FREEBSD
#include <machine/soundcard.h>
#define SOUND_DEVICE "/dev/dsp"
#endif

#ifdef SYSTEM_NETBSD
#include <sys/audioio.h>
#define SOUND_DEVICE "/dev/sound"
#endif

#ifdef SYSTEM_OPENBSD
#error No sound support on OpenBSD systems yet
#endif

#define MAGIC 2048
unsigned short final_wave[2048];
int waveptr;
int wavflag;
int sound_fd;
int _samples;
void snd_output_4_waves(int samples, u8 *wave1, u8 *wave2, u8 *wave3, u8 *wave4)
{
    int i;

    if (sound_fd) {
	for (i = 0; i < samples; i++) {
	    final_wave[waveptr] = (wave1[i] + wave2[i] +
				   wave3[i] + wave4[i]) << 5;
	    waveptr++;
	    if (waveptr == 2048) {
		waveptr = 0;
		wavflag = 2;
	    } else if (waveptr == 1024) {
		wavflag = 1;
	    }
	}
	
	if (wavflag) {
	    if (write(sound_fd, &final_wave[(wavflag - 1) << 10], 1024) < 1024) {
		deb_printf("wrote less than 1024 bytes\n");
	    }
	    wavflag = 0;
	}
    }
    _samples=samples;
}
int get_samples()
{
	return _samples;
}
void snd_init(void)
{
    sound_fd = 0;
    int i=0;
}

int snd_open(int samples_per_sync, int sample_rate)
{
    int tmp;
    int result;
    int sound_rate;
    int sound_frag;

    waveptr = 0;
    wavflag = 0;
    
    printf("opening "SOUND_DEVICE"...");
    sound_fd = open(SOUND_DEVICE, O_WRONLY);
    if (sound_fd < 0) {
	perror("failed");
	sound_fd = 0;
	return 0;
    } else {
	printf("done.\n");
    }
    
/*    printf("setting unsigned 16bit format...");
    tmp = AFMT_S16_LE;
    result = ioctl(sound_fd, SNDCTL_DSP_SETFMT, &tmp);
    if (result < 0) {
	perror("failed");
	close(sound_fd);
	sound_fd = 0;
	return 0;
    } else {
	printf("done.\n");
    }
    
    printf("setting mono mode...");
    tmp = 0;
	    result = ioctl(sound_fd, SNDCTL_DSP_CHANNELS, &tmp);
    if (result < 0) {
	perror("failed");
	close(sound_fd);
	sound_fd = 0;
	return 0;
    } else {
	printf("done.\n");
    }
*/    
    sound_rate = sample_rate;
    printf("setting sound rate to %dHz...", sound_rate);
    result = ioctl(sound_fd, SNDCTL_DSP_SPEED, &sound_rate);
    if (result < 0) {
	perror("failed");
	close(sound_fd);
	sound_fd = 0;
	return 0;
    } else {
	printf("got %dHz...done.\n", sound_rate);
    }

    /* high word of sound_frag is number of frags, low word is frag size */
/*    sound_frag = 0x00010400;
    printf("setting soundfrags...");
    result = ioctl(sound_fd, SNDCTL_DSP_SETFRAGMENT, &sound_frag);
    if (result < 0) {
	perror("failed");
	close(sound_fd);
	sound_fd = 0;
	return 0;
    } else {
	printf("done.\n");
    }*/

    return 1;
}

void snd_close(void)
{
    if (sound_fd) {
	close(sound_fd);
    }
}

/*
 * $Log: snd_unix.c,v $
 * Revision 1.4  2000/06/25 17:04:32  nyef
 * fixed to automatically detect system type
 *
 * Revision 1.3  2000/02/14 02:04:13  nyef
 * addded (untested) support for NetBSD
 *
 * Revision 1.2  1999/12/24 16:52:42  nyef
 * changed to compile clean on FreeBSD
 *
 * Revision 1.1  1999/10/31 02:37:58  nyef
 * Initial revision
 *
 */
